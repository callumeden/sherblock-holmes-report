\chapter{Fetching Historical Price Data}\label{section-price-data}
Users of the tool should be able to view the value of transactions at the time they took place, in a number of fiat currencies (such as GBP, USD and EUR). In order to achieve this functionality, the historical price index for Bitcoin must be collected and stored for the entire time spanning from the infancy of Bitcoin to the present day. Therefore, the objective of this contribution is to collect the historical exchange rates for every block from height 0 to 570,000, and to then to then store the various exchange rates as metadata with each block. 

\section{Source of price data}
Fortunately, CoinDesk have an API providing the historical Bitcoin price index data from late July 2010 onwards \cite{RefWorks:doc:5cacd8cbe4b092e311880f2b}. The API can fetch the daily price index for each day for a provided date range, supporting several fiat currencies.

\section{Storing the price data}
Since the historical price data retrieved from CoinDesk is at the granularity of one data point per day, and a block in Bitcoin is mined approximately every 10 minutes, it would be appropriate for the price data to be stored with each block in the database. Storing the data with each transaction output would not provide any additional value, and would lead us to encounter a greater storage overhead and computational resource in associating the price data with every transaction output in Bitcoin. Since each output is associated with a transaction as an output, and each transaction associated with the block it was mined in, we can easily find the price index data for an output in just a couple of hops. 
\\\\
The price index data for each block can therefore be fetched using the CoinDesk API and added to the CSV file containing all blocks.

\section{Matching price data to Bitcoin data}
As discussed in the previous section, it would be appropriate to store the historical exchange rate data with Bitcoin's block data. Using Python3, we created a program to accept CSV file names (for the block CSV files) as input (or a regex for matching files), read through each line of the CSV (representing a single block) and write a new output line with each row (block) augmented with the price data at the time the block was mined in GBP, USD and EUR. 
\\\\
Since at the time of writing, the current Bitcoin block height was $>$ 570,000, and it would not be efficient to perform a price index request for each block, 3 times over for each currency. Therefore, the program first checks a local cache to see if the price data is already available for a particular date. If not, it performs a fetch which collects the data for that date and the following 300 days and populates the cache. We therefore reduce the total number of requests made, and the overhead associated with making each request, while also avoiding requests of unnecessary data, caused by collecting data for a larger than required date range. For example, fetching 1000 days would lead to less requests being made for blocks covering several years, but an unnecessary overhead when fetching data for blocks covering only 100 days.

\section{Using the price data}
The price data is now associated with each Bitcoin Block in CSV format. These files can be used in the database import process in section \ref{section-blockchain-import} and the exchange rate figures can be stored with each block entry. When an exchange rate for a particular transaction is required, its relationship with the block it was mined in can be followed and the historical exchange rate for the time the transaction occurred can be found. 